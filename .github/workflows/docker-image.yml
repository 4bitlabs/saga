name: Build and Push Docker Image

on:
  push:
    branches: [ main, master, develop, helm-and-workflow ]
    paths:
      - 'src/**'
      - 'Dockerfile'
      - 'pom.xml'
      - '.github/workflows/docker-image.yml'
  pull_request:
    branches: [ main, master, helm-and-workflow ]
    paths:
      - 'src/**'
      - 'Dockerfile'
      - 'pom.xml'
      - '.github/workflows/docker-image.yml'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        provenance: false
    - name: Update Helm Chart values
      if: github.event_name != 'pull_request'
      run: |
        # Extrair as tags geradas
        ALL_TAGS="${{ steps.meta.outputs.tags }}"
        BRANCH_TAG=$(echo "$ALL_TAGS" | grep -E "^ghcr\.io/4bitlabs/saga:[a-zA-Z0-9-]+$" | head -n1 | sed 's/ghcr.io\/4bitlabs\/saga://')
        SHA_TAG=$(echo "$ALL_TAGS" | grep -E "^ghcr\.io/4bitlabs/saga:[a-zA-Z0-9-]+-[a-f0-9]+$" | head -n1 | sed 's/ghcr.io\/4bitlabs\/saga://')
        
        echo "Generated tags: $ALL_TAGS"
        echo "Branch tag: $BRANCH_TAG"
        echo "SHA tag: $SHA_TAG"
        
        # Determinar quais arquivos values.yaml atualizar baseado na branch
        CURRENT_BRANCH="${{ github.ref_name }}"
        
        # Sempre atualizar o values.yaml base para garantir que funcione sem especificar values file
        BASE_VALUES_FILE="helm/saga-chart/values.yaml"
        ENV_VALUES_FILE=""
        
        if [ "$CURRENT_BRANCH" = "develop" ]; then
          ENV_VALUES_FILE="helm/saga-chart/values-dev.yaml"
        elif [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
          ENV_VALUES_FILE="helm/saga-chart/values-prod.yaml"
        fi
        
        # Fun√ß√£o para atualizar tags de imagem em um arquivo values.yaml
        # Atualiza tanto app.image.tag quanto migration.image.tag
        update_values_file() {
          local file=$1
          # Atualizar todas as tags de imagem (app e migration)
          sed -i "s/tag: \".*\"/tag: \"$SHA_TAG\"/g" "$file"
          echo "Updated all image tags in $file to $SHA_TAG"
        }
        
        # Atualizar o values.yaml base sempre
        if [ -n "$SHA_TAG" ]; then
          update_values_file "$BASE_VALUES_FILE"
        fi
        
        # Atualizar o arquivo espec√≠fico do ambiente se aplic√°vel
        if [ -n "$ENV_VALUES_FILE" ] && [ -n "$SHA_TAG" ]; then
          update_values_file "$ENV_VALUES_FILE"
        fi
        
        # Commit e push das mudan√ßas (apenas se houver mudan√ßas, pois tava disparando erro quando n√£o tinha))
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add helm/saga-chart/values*.yaml
        
        # Verificar se h√° mudan√ßas para commit
        if git diff --staged --quiet; then
          echo "No changes to commit - tags are already up to date"
        else
          # Criar mensagem de commit apropriada
          if [ -n "$ENV_VALUES_FILE" ]; then
            COMMIT_MSG="chore: update image tags - base: $SHA_TAG, env: $SHA_TAG"
          else
            COMMIT_MSG="chore: update image tag to $SHA_TAG in values.yaml"
          fi
          git commit -m "$COMMIT_MSG"
          git push https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          echo "Changes committed and pushed successfully"
        fi
    - name: Notify deployment
      if: github.event_name != 'pull_request'
      run: |
        echo "üöÄ Docker image built and pushed successfully!"
        echo "üì¶ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
        echo "üè∑Ô∏è  Tags: ${{ steps.meta.outputs.tags }}"
        echo "üîó GitHub Container Registry: https://github.com/${{ github.repository }}/pkgs/container/$(echo ${{ env.IMAGE_NAME }} | cut -d'/' -f2)"


